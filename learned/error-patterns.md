# 錯誤模式記錄

> AI 會自動將遇到的 XS 撰寫錯誤記錄在此，避免重複犯錯。
> 格式：日期 + 錯誤描述 + 原因 + 修正方案

---

### 2026-02-25: 誤認 XS 無法匯出檔案
- **錯誤**: 告知用戶 XS 沒有檔案 I/O 功能，無法匯出 CSV
- **原因**: 未查閱 `Print` + `File` 函數，這兩個函數可將資料輸出到指定路徑的檔案
- **修正**: `Print(File("路徑"), 數值1, 數值2, ...)` 可輸出到任意路徑
- **補充**: 交易腳本必須使用 `Print(File(...), ...)` 才能列印到檔案；`File` 支援特殊變數 `[StrategyName]`、`[Symbol]`、`[Date]`、`[StartTime]`、`[Freq]`、`[ScriptName]`

### 2026-02-25: 誤認 Position/EntryPrice 僅為模擬數據
- **錯誤**: 告知用戶 `Position`、`EntryPrice`、`FilledAvgPrice` 只是回測模擬數據
- **原因**: XQ 交易腳本串接真實帳戶後，這些函數會回傳真實帳戶的持倉與成本
- **修正**: 串接真實帳戶即可取得真實庫存成本與部位

### 2026-02-25: 使用不支援的 EntryPrice 函數
- **錯誤**: 使用 `EntryPrice` 取得進場成本
- **原因**: 目前版本的 XQ 不支援 `EntryPrice` 語法
- **修正**: 改用 `FilledAvgPrice` 取得成交均價作為持倉成本
- **規則**: 取持倉成本一律用 `FilledAvgPrice`，禁止使用 `EntryPrice`

### 2026-02-25: File 路徑用目錄 vs 檔名的差異
- **錯誤**: 使用 `File("目錄\")` 導致每個商品各自產生獨立 LOG 檔
- **原因**: `File("目錄\")` 會自動以「策略名稱_商品代碼.log」分檔；`File("完整檔名.csv")` 才會所有商品寫入同一檔
- **修正**: 需要合併輸出時，使用 `File("完整路徑\檔名.csv")`；需要分檔時才用 `File("目錄\")`

### 2026-02-25: File() 不能存進 var 變數
- **錯誤**: `var: _File(File("path.csv"));` → 編譯錯誤 `var isn't a ELType`
- **原因**: `File()` 回傳的是特殊檔案句柄，不是 ELType（數值/字串/布林），無法用 `var` 儲存
- **修正**: 在每個 `Print()` 呼叫中直接寫 `File("路徑")`，不要用變數暫存
- **規則**: `File()` 只能作為 `Print()` 的第一個參數直接使用，禁止存入變數

### 2026-02-25: Position vs FilledAtBroker 的差異
- **錯誤**: 使用 `Position` 取得真實帳戶庫存，結果永遠是 0
- **原因**: `Position` 是腳本內部的部位追蹤（預設從 0 開始），不等於券商帳戶庫存。需要在策略設定中啟用「交易帳號庫存部位整合」才會同步
- **修正**: 取真實庫存用 **`FilledAtBroker`**（直接回傳券商帳號的實際庫存數量）
- **區分**: `Position` = 腳本預期部位；`Filled` = 腳本成交部位；`FilledAtBroker` = 券商帳號實際庫存

### 2026-02-25: 多商品共用 CSV 時 CurrentBar=1 表頭重複
- **錯誤**: 用 `if CurrentBar = 1` 輸出 CSV 表頭，導致每個商品各印一次表頭
- **原因**: `CurrentBar` 是每個商品獨立計數，多商品寫入同一 CSV 時每個商品都會觸發
- **修正**: 多商品共用單一 CSV 時，不要在腳本中印表頭，改由外部程式加上欄位名稱

### 2026-02-25: Print 輸出全部歷史 K 棒而非僅當日
- **修正**: 使用 `if IsLastBar then Print(...)` 僅輸出最新一根 K 棒的資料
- **注意**: `LastBarOnChart` 不是 XS 語法！正確函數為 **`IsLastBar`**（最新 K 棒）或 **`IsSessionLastBar`**（當日最後一根 K 棒）
